#!/bin/sh


# needed in order to read the config
apk add yq

config() {
	cat /root/config/choices.yml | yq eval .$1 -
}

enabled() {
        if [ "$(config "$1")" = true ]
        then
                return 0
        else
                return 1
        fi
}

persist() {
	# saves filesystem changes to persist after install and reboot
	lbu add $1
}

# keyboard
layout=$(config 'system.keyboard.layout')
variant=$(config 'system.keyboard.variant')
setup-keymap $layout $variant

# hostname
hostname=$(config 'system.hostname')
setup-hostname $hostname
rc-service hostname restart

# network
# network is already taken care of by the init script
# but has to be enabled after reboot
if enabled 'system.services.networkmanager'
then
	rc-update add networkmanager boot
fi

# timezone
timezone=$(config 'system.timezone')
setup-timezone $timezone

# apk repos
# apk repos are already configured by the prepare script
# this will override the default configuration before installing
mirror=$(config 'system.repository.apk.mirror')
case $mirror in
	default)
		args="-1";;
	fastest)
		args="-f";;
	random)
		args="-r";;
esac
if enabled 'system.repository.apk.community'
then
	args="-c $args"
fi
setup-apkrepos $args
if enabled 'system.repository.apk.edge-testing'
then
	mirror_url=$(cat /etc/apk/repositories | tail -n 1 | cut -d "/" -f 1-4)
	edge_testing="$mirror_url/edge/testing"
fi


# main user
username=$(config 'system.user.username')
password=$(config 'system.user.password')
# -a: admin (using this installs doas automatically)
# -g: groups
setup-user -a -g 'audio video netdev' "$username"
# TODO: adduser $username plugdev (if enabled 'system.services.networkmanager')
# the 'plugdev' group is added by NetworkManager, for rootless network management

# set the password for the user
echo "$username:$password" | chpasswd
# copy installer files to the home of the main user
cp -r /root/config /home/"$username"
cp /root/setup /home/"$username"
persist /home/$username


if enabled "system.services.seedrng"
then
	rc-update add seedrng boot
fi

for service in crond acpid
do
	if enabled "system.services.$service"
	then
		rc-update add $service
	fi
done



# disk install
yes | setup-disk -m sys /dev/vda

